{% extends 'base.html.twig' %}

{% block title %}Tworzenie pytania{% endblock %}

{% block body %}
    <div class="page-wrapper">
        <div class="row page-titles">
            <div class="col-12 align-self-center">
                <h3 class="text-themecolor mb-0">Tworzenie pytania</h3>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            {{ form_start(form) }}
                            <div class="form-body">
                                <div class="row">
                                    <div class="col-12">
                                        {{ form_row(form.name) }}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        {{ form_row(form.type) }}
                                    </div>
                                </div>

                                <div id="answers_block">
                                    {% if form.vars.value.answers is defined %}
                                        <div id="add_answers"
                                             data-prototype="{{ form_widget(form.answers.vars.prototype)|e('html_attr') }}">
                                            {% for key, answer in form.answers %}
                                                <div class="form-group">
                                                    <div>
                                                        <label class="required"></label>
                                                        <div id="add_answer_{{ key }}" class="row">
                                                            {{ form_row(answer.answer) }}
                                                            <div class="col-2 form-group d-flex align-items-center">
                                                                {{ form_widget(answer.correct) }}
                                                                {{ form_label(answer.correct) }}
                                                            </div>
                                                            {{ form_row(answer.delete) }}
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div id="add_answer_block">
                                    <div class="text-right mb-3">
                                        {% if form.vars.value.answers is defined %}
                                            <button type="button" class="add-another-collection-widget btn btn-info"
                                                    data-list-selector="#add_answers" onclick="addAnswer();">+1
                                                Odpowiedź
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>

                            </div>
                            <div class="form-actions">
                                <div class="text-right">
                                    <button type="submit" class="btn btn-info">Zapisz</button>
                                    <a class="btn btn-dark" href="{{ path('exam_show', {exam:app.request.get('exam').id}) }}">Anuluj</a>
                                </div>
                            </div>
                            {{ form_end(form) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {{ parent() }}
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        var $type = $('#add_type');
        $type.change(function() {
            var $form = $(this).closest('form');
            var data = {};
            data[$type.attr('name')] = $type.val();
            $.ajax({
                url : $form.attr('action'),
                type: $form.attr('method'),
                data : data,
                success: function(html) {
                    if($(html).find('#add_answers').length >= 1) {
                        console.log('tes');
                        $('#add_answer_block').replaceWith(
                            '<div id="add_answer_block" class="text-right mb-3">' +
                            '<button type="button" ' +
                            'class="add-another-collection-widget btn btn-info" ' +
                            'data-list-selector="#add_answers" ' +
                            'onclick="addAnswer();">+1 Odpowiedź</button>'+
                            '</div>'
                        );
                        $('#answers_block').replaceWith(
                            '<div id="answers_block">'+
                            $(html).find('#add_answers').get(0).outerHTML+
                            '</div>'
                        );
                        addAnswer();
                    } else {
                        console.log('tes 2');
                        $('#add_answer_block').replaceWith('<div id="add_answer_block"></div>');
                        $('#answers_block').replaceWith('<div id="answers_block"></div>');
                    }
                }
            });
        });

        function addAnswer() {
            var list = $('#add_answers');
            var counter = list.data('widget-counter') || list.children().length;
            var newWidget = list.attr('data-prototype');
            var label = '<label for="add_answers___name___correct">Prawidłowa</label>';
            var input = '<input type="checkbox" id="add_answers___name___correct" name="add[answers][__name__][correct]" class="material-inputs filled-in chk-col-light-blue" value="1" />';
            newWidget = newWidget.replace(/__name__label__/g,'');
            newWidget = newWidget.replace(label+input,input+label);
            newWidget = newWidget.replace(/__name__/g, counter);
            counter++;
            list.data('widget-counter', counter);
            var newElem = $('<div class="form-group"></div>').html(newWidget);
            newElem.appendTo(list);
        }

        function deleteAnswer(id) {
            $('#'+id).parent().parent().parent().remove();
        }
    </script>
{% endblock %}